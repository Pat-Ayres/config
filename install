#!/usr/bin/env bash

set -e  # Exit immediately if a command exits with a non-zero status

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect the operating system
detect_os() {
    case "$(uname -s)" in
        Linux)
            echo "linux"
            ;;
        Darwin)
            echo "macos"
            ;;
        *)
            echo "unsupported"
            ;;
    esac
}

brew_setup() {
  if ! command -v brew &> /dev/null; then
    echo "Homebrew not found, installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
  else
    echo "updating brew..."
    brew update
  fi

  echo "installing brew packages..."
  brew bundle --file="$SCRIPT_DIR/macos/Brewfile"

  echo "Brew setup completed."
}

neovim_config_setup() {
  if [[ ! -d $HOME/.config/nvim ]]; then
    git clone https://github.com/Pat-Ayres/neovim-conf.git $HOME/.config/nvim
  fi
}

symlink_dotfiles() {
  echo "symlinking dots..."
  ln -sf ${SCRIPT_DIR}/bash_aliases ${HOME}/.bash_aliases
  ln -sf ${SCRIPT_DIR}/bashrc ${HOME}/.bashrc
  # ln -sf ${SCRIPT_DIR}/ghostty ${HOME}/.config/ghostty
  ln -sf ${SCRIPT_DIR}/gitconfig ${HOME}/.gitconfig
  ln -sf ${SCRIPT_DIR}/inputrc ${HOME}/.inputrc
  ln -sf ${SCRIPT_DIR}/profile ${HOME}/.profile
  ln -sf ${SCRIPT_DIR}/ruby-version ${HOME}/.ruby-version
  ln -sf ${SCRIPT_DIR}/starship.toml ${HOME}/.config/starship.toml
  ln -sf ${SCRIPT_DIR}/tmux ${HOME}/.tmux
  ln -sf ${SCRIPT_DIR}/tmux.conf ${HOME}/.tmux.conf
  ln -sf ${SCRIPT_DIR}/zprofile ${HOME}/.zprofile
  ln -sf ${SCRIPT_DIR}/zshaliases ${HOME}/.zshaliases
  ln -sf ${SCRIPT_DIR}/zshenv ${HOME}/.zshenv
  ln -sf ${SCRIPT_DIR}/zshrc ${HOME}/.zshrc
}

# Main script logic
main() {
  local operating_system=$(detect_os)
  if [[ $operating_system == "unsupported" ]]; then
    echo "Unsupported operating system."
    exit 1
  fi

  if [[ $operating_system == "macos" ]]; then
    brew_setup
    neovim_config_setup
  fi

  symlink_dotfiles

  echo "Config install completed."
}

main
